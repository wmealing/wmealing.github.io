<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-10-24 Tue 22:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Github actions (CI/CD) for LFE.</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=B612&display=swap" rel="stylesheet">
<link rel="stylesheet" href="tufte.css" type="text/css" />
<style> * { font-family: 'B612', sans-serif; } </style>
<meta http-equiv="Content-Security-Policy"  content="default-src 'self'; img-src https://*; child-src 'none';">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Github actions (CI/CD) for LFE.</h1>

<div id="outline-container-org1e9e320" class="outline-2">
<h2 id="org1e9e320">What is CD/CD ?</h2>
<div class="outline-text-2" id="text-org1e9e320">
<p>
If you want to take the headache and room for human error out of delivering software, the current trend is to
use "Continious Integration" and "Continious Delivery" which is a fancy word for automated testing of Merge requests
and automated delivery (whatever that means for your project).
</p>

<p>
There are many companies in this space, the one that I'm focusing on is githubs CI/CD platform which they have
branded as 'GitHub Actions'.
</p>

<p>
In their words:
</p>

<pre class="example" id="orge6b14dd">
GitHub Actions is a continuous integration and continuous delivery (CI/CD) platform that
allows you to automate your build, test, and deployment pipeline. You can create workflows
that build and test every pull request to your repository, or deploy merged pull requests
to production.
</pre>
</div>
</div>

<div id="outline-container-orgadfa99c" class="outline-2">
<h2 id="orgadfa99c">Why do I need it ?</h2>
<div class="outline-text-2" id="text-orgadfa99c">
<p>
Github have a high level overview of their offerings, along with how they expect it to be
used <a href="https://resources.github.com/ci-cd/">on their github resources page</a>. With minimal effort, you can find many well thought out sites that
extoll the reasoning and logic of using CI/CD, repeating it here would be pointless.
</p>

<p>
I'm going to talk about it specifically in the context of automating
your LFE testing and container image generation.
</p>


<p>
Unlike the GitHub docs, I'm not giving you the shiny version, only how I see it.
</p>
</div>
</div>


<div id="outline-container-orgf2cc975" class="outline-2">
<h2 id="orgf2cc975">How it works.</h2>
<div class="outline-text-2" id="text-orgf2cc975">
<ol class="org-ol">
<li>An event occurs on your repository (push, pull, mr ).</li>
<li>GitHub searches the .github/workflows directory in your repository for "yml" workflow files that are present.</li>
<li><p>
A workflow run is triggered for any workflows that have on: values that match the triggering event.
Each workflow run will use the version of the workflow that is present in the associated branch at that time.
</p>

<p>
(To put it bluntly, it runs with the version that of the '.github/workflow/*.yaml' at the time).
</p></li>
</ol>


<p>
So, how to get this up and running quickly, create a .github/config/ci-cd.yaml file.
</p>

<p>
Here is an example that I used.
</p>

<div class="org-src-container">
<pre class="src src-yaml.">name: ci/cd

on:
  push:
    branches: [ main ]

  pull_request:
    branches: [ main ]

jobs:

  build:
    name: Build and run on OTP-26 and latest LFE.
    runs-on: ubuntu-latest

    container:
      image: erlang:26

    steps:
    - uses: actions/checkout@v4
    - name: Check rebar3 Version
      run: DEBUG=1 rebar3 --version
    - name: Compile
      run: rebar3 lfe compile

    - name: Run Tests
      run: rebar3 as test lfe ltest
</pre>
</div>

<p>
This spins up a basic ubuntu image, with erlang 26 installed, your specific app may require
another newer (or older) version of the erlang VM (BEAM) please adjust the above as necessary.
</p>

<p>
Rebar is also installed on the image, and when configured to use lfe, will also fetch the libraries
configured in the rebar.config file during the build process.
</p>

<p>
This example compiles and runs the tests. 
</p>

<p>
Listed below is the rebar.config that
worked for me.
</p>


<div class="org-src-container">
<pre class="src src-erlang"><span style="color: #FF4F00;">{</span>erl_opts, <span style="color: #E14400;">[</span>debug_info<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.

<span style="color: #FF4F00;">{</span>deps, <span style="color: #E14400;">[</span>
    <span style="color: #D04000;">{</span>lfe, <span style="color: #FF6A00;">"2.1.2"</span><span style="color: #D04000;">}</span>
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.

<span style="color: #FF4F00;">{</span>plugins, <span style="color: #E14400;">[</span>
    <span style="color: #D04000;">{</span>rebar3_lfe, <span style="color: #FF6A00;">"0.4.8"</span><span style="color: #D04000;">}</span>
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.


<span style="color: #FF4F00;">{</span>provider_hooks, <span style="color: #E14400;">[</span>
    <span style="color: #D04000;">{</span>pre, <span style="color: #AA3A00;">[</span><span style="color: #FF4F00;">{</span>compile, <span style="color: #E14400;">{</span>lfe, compile<span style="color: #E14400;">}</span><span style="color: #FF4F00;">}</span><span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span>
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.

<span style="color: #FF4F00;">{</span>xref_checks,<span style="color: #E14400;">[</span>
    undefined_function_calls,undefined_functions,locals_not_used,
    deprecated_function_calls,deprecated_functions
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.

<span style="color: #FF4F00;">{</span>profiles, <span style="color: #E14400;">[</span>
    <span style="color: #D04000;">{</span>prod, <span style="color: #AA3A00;">[</span>
        <span style="color: #FF4F00;">{</span>relx, <span style="color: #E14400;">[</span>
            <span style="color: #D04000;">{</span>dev_mode, false<span style="color: #D04000;">}</span>,
            <span style="color: #D04000;">{</span>include_erts, true<span style="color: #D04000;">}</span>
       <span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>
    <span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span>,
    <span style="color: #D04000;">{</span>test, <span style="color: #AA3A00;">[</span>
        <span style="color: #FF4F00;">{</span>deps, <span style="color: #E14400;">[</span>
            <span style="color: #D04000;">{</span>proper, <span style="color: #FF6A00;">"1.4.0"</span><span style="color: #D04000;">}</span>
        <span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>,
        <span style="color: #FF4F00;">{</span>plugins, <span style="color: #E14400;">[</span>
            <span style="color: #D04000;">{</span>rebar3_proper, <span style="color: #FF6A00;">"0.12.1"</span><span style="color: #D04000;">}</span>
        <span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>,
        <span style="color: #FF4F00;">{</span>eunit_opts, <span style="color: #E14400;">[</span>verbose<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>,
        <span style="color: #FF4F00;">{</span>erl_opts, <span style="color: #E14400;">[</span><span style="color: #D04000;">{</span>src_dirs, <span style="color: #AA3A00;">[</span><span style="color: #FF6A00;">"src"</span>, <span style="color: #FF6A00;">"test"</span><span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span><span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>
    <span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span>
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.

<span style="color: #FF4F00;">{</span>alias, <span style="color: #E14400;">[</span>
    <span style="color: #D04000;">{</span>coverage, <span style="color: #AA3A00;">[</span>
        <span style="color: #FF4F00;">{</span>proper, <span style="color: #FF6A00;">"-c"</span><span style="color: #FF4F00;">}</span>,
        <span style="color: #FF4F00;">{</span>cover, <span style="color: #FF6A00;">"-v --min_coverage=0"</span><span style="color: #FF4F00;">}</span>
    <span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span>,
    <span style="color: #D04000;">{</span>check, <span style="color: #AA3A00;">[</span>
        compile,
        xref,
        <span style="color: #969896; font-style: italic;">%%</span><span style="color: #D05010; font-style: italic;">dialyzer,</span>
        eunit,
        coverage
    <span style="color: #AA3A00;">]</span><span style="color: #D04000;">}</span>
<span style="color: #E14400;">]</span><span style="color: #FF4F00;">}</span>.
</pre>
</div>

<p>
Now when you do a 'git push' you should see this 'action' being run under the action tab of your project.
</p>

<p>
This is a very simple GitHub Action, that will allow you to see the basics of how CI/CD works.  The "Delivery"
part of this , I will probably expand on in another post.
</p>
</div>
</div>


<div id="outline-container-org7b3c56f" class="outline-2">
<h2 id="org7b3c56f">Resources:</h2>
<div class="outline-text-2" id="text-org7b3c56f">
<p>
<a href="https://github.com/wmealing/CI-CD-TEST/tree/main">https://github.com/wmealing/CI-CD-TEST/tree/main</a>
</p>
</div>
</div>
</div>
</body>
</html>